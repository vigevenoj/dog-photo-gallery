# doggallery

I don't know about you, but I love seeing pictures of my dogs. I like being reminded about what they were up to a year ago,
and I'll probably want to be reminded about their past antics on any given day of the year.

I couldn't find a photo-sharing site that really met my needs, so I wrote this.

It's a basic photo-displaying site with an API that suits my needs, storing photo metadata in PostgreSQL, image data in
an s3-compatible object storage system, and using imgproxy to handle image resizing operations.

## Prerequisites

You will need [Leiningen](https://github.com/technomancy/leiningen) 2.0 or above installed. 

## Development mode
The docker-compose.yml in the root can start up localstack and imgproxy for local development. 
Uncomment the database information if that is required as well. Start the docker-compose services
with `docker-compose up`

In another terminal, start the doggallery service with `lein repl` and then `(start)`.

## Configuration
These keys are required
* `:imgproxy-base-url` : Base URL for accessing your imgproxy service
* `:imgproxy-key` : Key for signing requests to imgproxy service
* `:imgproxy-salt` : salt for signing requests to imgproxy service
* `:object-storage-access-key` : key for accessing object storage
* `:object-storage-secret-key` : key for accessing object storage
* `:object-storage-region` : region for object storage
* `:object-storage-endpoint` : This is used for using an s3-compatible object storage service that is not s3
* `:bucket-name` : The name of the bucket where the photos will be stored
* `:uuid-namespace` : Every image is given a uuid generated by `(clj-uuid/v5 (env :uuid-namespace) photo)`.
* `:database-url` : URL for accessing the database

## Running locally

To start a web server for the application, run:

    lein run 

## Running in production

Either provide a config.edn or export the necessary environment variables, and then either run the jar directly or pass
that configuration into the docker image.

There isn't any user management or security built into this. I'm using traefik+authelia to secure routes that should 
require authentication.

## Fixing metadata in production
If `taken` is null but the metadata has been populated, this query can find the data that needs to be updated:
```
select name, taken, coalesce(metadata #>> '{date}', metadata #>> '{date-time}', metadata #>> '{exif:DateTimeOriginal}')::timestamp 
from photos 
where taken is null and 
coalesce(metadata #>> '{date}', metadata #>> '{date-time}', metadata #>> '{exif:DateTimeOriginal}') is not null limit 10;
```

You can fix them with this query:
```
update photos 
set taken = coalesce(metadata #>> '{date}', metadata #>> '{date-time}', metadata #>> '{exifDateTimeOriginal}')::timestamp 
where taken is null and 
coalesce(metadata #>> '{date}', metadata #>> '{date-time}', metadata #>> '{exif:DateTimeOriginal}') is not null;
```

## License

Copyright Â© 2021 


# TODO
* image handling
  * determine orientation and adjust to handle portrait and landscape without distortion
  * generate thumbnails (save thumbnails in order to cache them)
  * resize image to various sizes and provide a srcset for responsive design
* API
  * most recent photos (add pagination)
  * admin feature for finding images without date-taken metadata and fixing them
* Security
  * Use keycloak or other oidc provider to secure routes that should require authentication.